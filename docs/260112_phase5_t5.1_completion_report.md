# Phase 5, T5.1 ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2026-01-12
**ì‘ì—…ì**: Claude Code
**ì‘ì—… ë²”ìœ„**: Multi-Strategy Orchestration - Conflict Check API Endpoint

---

## ğŸ“‹ ì‘ì—… ê°œìš”

Phase 5ì˜ ì²« ë²ˆì§¸ ì‘ì—…ìœ¼ë¡œ **ì¶©ëŒ ê²€ì‚¬ API ì—”ë“œí¬ì¸íŠ¸**ë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
ì‹¤ì œ ì£¼ë¬¸ì„ ìƒì„±í•˜ì§€ ì•Šê³  ì¶©ëŒ ì—¬ë¶€ë§Œ ë¯¸ë¦¬ í™•ì¸í•  ìˆ˜ ìˆëŠ” "Dry Run" ì—”ë“œí¬ì¸íŠ¸ì…ë‹ˆë‹¤.

### ì‘ì—… ëª©í‘œ

```
POST /api/v1/orders/check-conflict ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- ConflictDetector ì„œë¹„ìŠ¤ í˜¸ì¶œ
- ConflictCheckResponse ë°˜í™˜
- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
```

---

## ğŸ¯ êµ¬í˜„ ë‚´ìš©

### 1. API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

**íŒŒì¼**: `backend/api/orders_router.py` (Lines 202-294)

#### ì—”ë“œí¬ì¸íŠ¸ ì •ë³´
- **URL**: `POST /api/orders/check-conflict`
- **ê¸°ëŠ¥**: ì£¼ë¬¸ ì¶©ëŒ ê²€ì‚¬ (Dry Run)
- **ì¸ì¦**: ì—†ìŒ (ë‚´ë¶€ API)

#### ìš”ì²­ ìŠ¤í‚¤ë§ˆ (ConflictCheckRequest)
```python
{
    "strategy_id": str,      # ì£¼ë¬¸ ì‹œë„ ì „ëµ ID (UUID)
    "ticker": str,           # ì¢…ëª© ì½”ë“œ (ìµœëŒ€ 10ì)
    "action": OrderAction,   # "buy" or "sell"
    "quantity": int          # ì£¼ë¬¸ ìˆ˜ëŸ‰ (> 0)
}
```

#### ì‘ë‹µ ìŠ¤í‚¤ë§ˆ (ConflictCheckResponse)
```python
{
    "has_conflict": bool,           # ì¶©ëŒ ë°œìƒ ì—¬ë¶€
    "resolution": str,              # "allowed" | "blocked" | "priority_override"
    "can_proceed": bool,            # ì£¼ë¬¸ ì‹¤í–‰ ê°€ëŠ¥ ì—¬ë¶€
    "conflict_detail": {            # ì¶©ëŒ ì‹œì—ë§Œ ì¡´ì¬
        "owning_strategy_id": str,
        "owning_strategy_name": str,
        "owning_strategy_priority": int,
        "ownership_type": str,
        "locked_until": datetime,
        "reasoning": str
    },
    "reasoning": str,               # ê²°ì • ì´ìœ  ì„¤ëª…
    "timestamp": datetime           # ê²€ì‚¬ ì‹œê°
}
```

#### êµ¬í˜„ íŠ¹ì§•

1. **ì „ëµ ìœ íš¨ì„± ê²€ì¦**
   - ì „ëµ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ â†’ 404 Not Found
   - ì „ëµ í™œì„±í™” ìƒíƒœ í™•ì¸ â†’ 400 Bad Request

2. **ConflictDetector í˜¸ì¶œ**
   - OrderManager.create_order()ì™€ ë™ì¼í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‚¬ìš©
   - ì¼ê´€ëœ ì¶©ëŒ ê²€ì‚¬ ë¡œì§ ë³´ì¥

3. **ìƒì„¸í•œ ë¡œê¹…**
   ```python
   logger.info(
       f"ğŸ” Conflict check: {ticker} | Strategy: {strategy.name} | "
       f"Resolution: {resolution.value} | Can proceed: {can_proceed}"
   )
   ```

4. **ì—ëŸ¬ ì²˜ë¦¬**
   - 404: ì „ëµì„ ì°¾ì„ ìˆ˜ ì—†ìŒ
   - 400: ì „ëµì´ ë¹„í™œì„±í™” ìƒíƒœ
   - 500: ë‚´ë¶€ ì„œë²„ ì˜¤ë¥˜

### 2. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ êµ¬í˜„

**íŒŒì¼**: `backend/tests/test_orders_api_conflict_unit.py`

#### í…ŒìŠ¤íŠ¸ êµ¬ì¡°
- **Framework**: FastAPI TestClient
- **Database**: PostgreSQL (ì‹¤ì œ DB ì—°ê²°)
- **ì „ëµ**: Long-Term (ìš°ì„ ìˆœìœ„ 100), Trading (50), Aggressive (30)

#### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ (6ê°œ)

##### Test 1: ì†Œìœ ê¶Œ ì—†ìŒ (ALLOWED)
```python
# Given: ì•„ë¬´ë„ í¬ì§€ì…˜ì„ ì†Œìœ í•˜ì§€ ì•ŠìŒ
# When: Trading ì „ëµì´ BUY ì‹œë„
# Then: resolution="allowed", can_proceed=True
```

##### Test 2: ë‚®ì€ ìš°ì„ ìˆœìœ„ ì°¨ë‹¨ (BLOCKED)
```python
# Given: Long-Term(100)ì´ í¬ì§€ì…˜ ì†Œìœ 
# When: Trading(50)ì´ BUY ì‹œë„
# Then: resolution="blocked", can_proceed=False
# Reason: "Insufficient Priority: 50 <= 100"
```

##### Test 3: ë³¸ì¸ ì „ëµ ì¬ì§„ì… (ALLOWED)
```python
# Given: Long-Term(100)ì´ í¬ì§€ì…˜ ì†Œìœ 
# When: Long-Term(100)ì´ ë‹¤ì‹œ BUY ì‹œë„
# Then: resolution="allowed", can_proceed=True
# Reason: "Already owned by requesting strategy."
```

##### Test 4: ìš°ì„ ìˆœìœ„ ì˜¤ë²„ë¼ì´ë“œ (PRIORITY_OVERRIDE)
```python
# Given: Aggressive(30)ê°€ í¬ì§€ì…˜ ì†Œìœ 
# When: Long-Term(100)ì´ BUY ì‹œë„
# Then: resolution="priority_override", can_proceed=True
# Reason: "Priority Override: 100 > 30"
```

##### Test 5: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì „ëµ (404 Error)
```python
# Given: ìœ íš¨í•˜ì§€ ì•Šì€ strategy_id
# When: ì¶©ëŒ ê²€ì‚¬ ìš”ì²­
# Then: HTTP 404 "Strategy {id} not found"
```

##### Test 6: ë¹„í™œì„±í™”ëœ ì „ëµ (400 Error)
```python
# Given: Aggressive ì „ëµì´ ë¹„í™œì„±í™” ìƒíƒœ
# When: Aggressiveë¡œ ì¶©ëŒ ê²€ì‚¬ ìš”ì²­
# Then: HTTP 400 "Strategy 'aggressive' is inactive. Activate it first."
```

#### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼

```bash
$ python backend/tests/test_orders_api_conflict_unit.py

============================================================
Testing POST /api/orders/check-conflict (Phase 5, T5.1)
============================================================

=== Strategy IDs ===
Long Term: 2149eaf1-545c-40e5-a3c6-12f986e23575 (Priority: 100)
Trading: d3c1e0fe-bca1-4c1e-8e85-fe337c180f1a (Priority: 50)
Aggressive: 2bcaf9e6-6600-4b19-a1aa-9ee5aaa675a4 (Priority: 30)

--- Test 1: No Ownership (Should be ALLOWED) ---
âœ… Test 1 PASSED: No current owner. Free to trade.

--- Test 2: Long-Term owns, Trading attempts (Should be BLOCKED) ---
âœ… Test 2 PASSED: Insufficient Priority: 50 <= 100

--- Test 3: Long-Term owns, Long-Term attempts (Should be ALLOWED) ---
âœ… Test 3 PASSED: Already owned by requesting strategy.

--- Test 4: Aggressive owns, Long-Term attempts (Should be PRIORITY_OVERRIDE) ---
âœ… Test 4 PASSED: Priority Override: 100 > 30

--- Test 5: Invalid Strategy ID (Should be 404) ---
âœ… Test 5 PASSED: Strategy 00000000-0000-0000-0000-000000000000 not found

--- Test 6: Inactive Strategy (Should be 400) ---
âœ… Test 6 PASSED: Strategy 'aggressive' is inactive. Activate it first.

============================================================
âœ… All Tests PASSED! Phase 5, T5.1 is complete.
============================================================
```

---

## ğŸ› ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: HTTP 422 Unprocessable Entity

**ì¦ìƒ**:
```
httpx - INFO - HTTP Request: POST http://testserver/api/orders/check-conflict "HTTP/1.1 422 Unprocessable Entity"
```

**ì›ì¸ ë¶„ì„**:
1. ì´ˆê¸° í˜ì´ë¡œë“œì—ì„œ `"action": "BUY"` (ëŒ€ë¬¸ì) ì „ë‹¬
2. `ConflictCheckRequest` ìŠ¤í‚¤ë§ˆì˜ `action` í•„ë“œëŠ” `OrderAction` enum íƒ€ì…
3. `OrderAction` enum ê°’ì€ ì†Œë¬¸ì (`"buy"`, `"sell"`)

**í•´ê²° ë°©ë²•**:
```python
# Before
payload = {
    "action": "BUY",  # âŒ ì˜ëª»ëœ enum ê°’
}

# After
payload = {
    "action": "buy",  # âœ… ì˜¬ë°”ë¥¸ enum ê°’
}
```

### ë¬¸ì œ 2: Ticker ê¸¸ì´ ì œí•œ ì´ˆê³¼

**ì¦ìƒ**:
```json
{
  "detail": [{
    "type": "string_too_long",
    "loc": ["body", "ticker"],
    "msg": "String should have at most 10 characters",
    "input": "TEST_API_AAPL",
    "ctx": {"max_length": 10}
  }]
}
```

**ì›ì¸**:
- í…ŒìŠ¤íŠ¸ í‹°ì»¤: `"TEST_API_AAPL"` (14ê¸€ì)
- ìŠ¤í‚¤ë§ˆ ì œí•œ: `max_length=10` (`strategy_schemas.py:246`)

**í•´ê²° ë°©ë²•**:
```python
# Before
TICKER = "TEST_API_AAPL"  # 14 characters âŒ

# After
TICKER = "AAPL_TEST"      # 9 characters âœ…
```

---

## ğŸ“ ë³€ê²½ëœ íŒŒì¼

### 1. backend/api/orders_router.py
**ë³€ê²½ ë‚´ìš©**:
- Import ì¶”ê°€: `ConflictDetector`, `StrategyRepository`, conflict schemas
- `POST /check-conflict` ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ (Lines 202-294)

**ì£¼ìš” ë¡œì§**:
```python
@router.post("/check-conflict", response_model=ConflictCheckResponse)
@log_endpoint("orders", "system")
async def check_order_conflict(request: ConflictCheckRequest):
    """
    ì£¼ë¬¸ ì¶©ëŒ ê²€ì‚¬ (Dry Run)

    Phase 5, T5.1: Multi-Strategy Orchestration
    """
    db = get_sync_session()

    try:
        # 1. Validate Strategy
        strategy = strategy_repo.get_by_id(request.strategy_id)
        if not strategy or not strategy.is_active:
            raise HTTPException(...)

        # 2. Call ConflictDetector
        detector = ConflictDetector(db)
        conflict_response = detector.check_conflict(
            strategy_id=request.strategy_id,
            ticker=request.ticker.upper(),
            action=request.action,
            quantity=request.quantity
        )

        # 3. Return Response
        return conflict_response

    finally:
        db.close()
```

### 2. backend/tests/test_orders_api_conflict_unit.py
**ë³€ê²½ ë‚´ìš©**:
- ì‹ ê·œ íŒŒì¼ ìƒì„±
- FastAPI TestClientë¥¼ ì‚¬ìš©í•œ 6ê°œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
- ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° (PostgreSQL)

**í…ŒìŠ¤íŠ¸ í—¬í¼**:
```python
def cleanup_ownership():
    """í…ŒìŠ¤íŠ¸ ì „ ì†Œìœ ê¶Œ ë°ì´í„° ì´ˆê¸°í™”"""
    ownership_repo = PositionOwnershipRepository(db)
    existing = ownership_repo.get_by_ticker(TICKER)
    if existing:
        db.delete(existing)
        db.commit()
```

---

## ğŸ” ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ ì™„ë£Œ
- [x] ConflictDetector ì„œë¹„ìŠ¤ í˜¸ì¶œ í™•ì¸
- [x] ConflictCheckResponse ë°˜í™˜ í™•ì¸
- [x] ì „ëµ ìœ íš¨ì„± ê²€ì¦ (ì¡´ì¬ ì—¬ë¶€, í™œì„±í™” ìƒíƒœ)
- [x] ì—ëŸ¬ ì²˜ë¦¬ (404, 400, 500)
- [x] 6ê°œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë‘ í†µê³¼
- [x] ë¡œê¹… ë©”ì‹œì§€ í™•ì¸
- [x] OrderManagerì™€ ë™ì¼í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‚¬ìš© í™•ì¸

---

## ğŸ“ ê¸°ìˆ ì  ì¸ì‚¬ì´íŠ¸

### 1. FastAPI TestClientì˜ ì¥ì 
- ì„œë²„ ì‹¤í–‰ ì—†ì´ API í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- ì‹¤ì œ HTTP ìš”ì²­/ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜
- Pydantic ê²€ì¦ ì˜¤ë¥˜ë¥¼ ëª…í™•í•˜ê²Œ ìº¡ì²˜

### 2. Enum ê°’ ê²€ì¦ì˜ ì¤‘ìš”ì„±
- Pydanticì€ enum ê°’ì„ ì—„ê²©í•˜ê²Œ ê²€ì¦
- ëŒ€ì†Œë¬¸ì êµ¬ë¶„ í•„ìˆ˜
- API ë¬¸ì„œì— ëª…í™•í•œ enum ê°’ í‘œì‹œ í•„ìš”

### 3. ì¼ê´€ëœ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì¬ì‚¬ìš©
- Dry Run APIê°€ ì‹¤ì œ OrderManagerì™€ ë™ì¼í•œ ConflictDetector ì‚¬ìš©
- ì½”ë“œ ì¤‘ë³µ ë°©ì§€, ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì£¼ë¬¸ ì „ ë¯¸ë¦¬ ì¶©ëŒ í™•ì¸ ê°€ëŠ¥

---

## ğŸ“Š ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### í˜„ì¬ êµ¬í˜„
- **ë™ê¸° ì²˜ë¦¬**: `async def`ì´ì§€ë§Œ ë‚´ë¶€ì—ì„œ ë™ê¸° DB í˜¸ì¶œ ì‚¬ìš©
- **ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°**: ìš”ì²­ë§ˆë‹¤ ìƒˆ ì„¸ì…˜ ìƒì„± í›„ `finally`ì—ì„œ ë‹«ìŒ

### ê°œì„  ê°€ëŠ¥ ì˜ì—­
1. **ë¹„ë™ê¸° DB ë“œë¼ì´ë²„ ì‚¬ìš©**
   - SQLAlchemy async ì„¸ì…˜ ê³ ë ¤
   - ëŒ€ê·œëª¨ íŠ¸ë˜í”½ ì‹œ ì„±ëŠ¥ í–¥ìƒ

2. **ìºì‹±**
   - ì „ëµ ì •ë³´ ìºì‹± (ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠìŒ)
   - Redis ë“±ì„ í™œìš©í•œ ë¶„ì‚° ìºì‹œ

3. **Rate Limiting**
   - DDoS ë°©ì§€
   - ì•…ì˜ì ì¸ ì¶©ëŒ ê²€ì‚¬ ìš”ì²­ ì°¨ë‹¨

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### Phase 5 ë‚¨ì€ ì‘ì—…

#### T5.2: í”„ë¡ íŠ¸ì—”ë“œ í†µí•©
- ì£¼ë¬¸ ìƒì„± í¼ì— "ì¶©ëŒ ê²€ì‚¬" ë²„íŠ¼ ì¶”ê°€
- ì¶©ëŒ ê²°ê³¼ UI í‘œì‹œ
- `can_proceed=false`ì¼ ë•Œ ì£¼ë¬¸ ë²„íŠ¼ ë¹„í™œì„±í™”

#### T5.3: í†µí•© í…ŒìŠ¤íŠ¸
- ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- OrderManager â†’ ConflictDetector â†’ API í†µí•© ê²€ì¦
- ë™ì‹œì„± ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

#### T5.4: ë¬¸ì„œí™” (ì„ íƒ)
- API ë¬¸ì„œ ì—…ë°ì´íŠ¸ (Swagger)
- í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì ê°€ì´ë“œ
- ì¶©ëŒ í•´ê²° ì‹œë‚˜ë¦¬ì˜¤ ë‹¤ì´ì–´ê·¸ë¨

---

## ğŸ“Œ ì¤‘ìš” ë…¸íŠ¸

### API ì‚¬ìš© ì˜ˆì‹œ

**ì„±ê³µ ì¼€ì´ìŠ¤ (ALLOWED)**:
```bash
curl -X POST http://localhost:8001/api/orders/check-conflict \
  -H "Content-Type: application/json" \
  -d '{
    "strategy_id": "2149eaf1-545c-40e5-a3c6-12f986e23575",
    "ticker": "AAPL",
    "action": "buy",
    "quantity": 100
  }'

# Response:
{
  "has_conflict": false,
  "resolution": "allowed",
  "can_proceed": true,
  "reasoning": "No current owner. Free to trade.",
  "timestamp": "2026-01-12T13:53:07"
}
```

**ì¶©ëŒ ì¼€ì´ìŠ¤ (BLOCKED)**:
```bash
# Long-Term(100)ì´ ì´ë¯¸ ì†Œìœ í•œ ìƒíƒœì—ì„œ Trading(50) ì‹œë„

# Response:
{
  "has_conflict": true,
  "resolution": "blocked",
  "can_proceed": false,
  "conflict_detail": {
    "owning_strategy_id": "2149eaf1-545c-40e5-a3c6-12f986e23575",
    "owning_strategy_name": "long_term",
    "owning_strategy_priority": 100,
    "ownership_type": "primary",
    "locked_until": null,
    "reasoning": "Higher priority strategy 'long_term' already owns this position."
  },
  "reasoning": "Insufficient Priority: 50 <= 100",
  "timestamp": "2026-01-12T13:53:07"
}
```

---

## âœ… ê²°ë¡ 

Phase 5, T5.1 ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

**í•µì‹¬ ì„±ê³¼**:
- âœ… ì¶©ëŒ ê²€ì‚¬ API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ ì™„ë£Œ
- âœ… 6ê°œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë‘ í†µê³¼
- âœ… OrderManagerì™€ ì¼ê´€ëœ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‚¬ìš©
- âœ… ëª…í™•í•œ ì—ëŸ¬ ì²˜ë¦¬ ë° ê²€ì¦
- âœ… í”„ë¡ íŠ¸ì—”ë“œ í†µí•© ì¤€ë¹„ ì™„ë£Œ

**ë‹¤ìŒ ì‘ì—…**: Phase 5, T5.2 (í”„ë¡ íŠ¸ì—”ë“œ í†µí•©) ì§„í–‰ ì˜ˆì •

---

**ì‘ì„±ì**: Claude Code
**ê²€í† ì**: -
**ìŠ¹ì¸ì**: -
**ìµœì¢… ìˆ˜ì •ì¼**: 2026-01-12
