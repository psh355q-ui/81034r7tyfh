"""
Prompt Builder - v2.3 모드별 프롬프트 생성

ChatGPT/Gemini 합의 기반:
1. Closing = 결과 중심 (교과서적 정의 금지)
2. Morning = 시나리오 중심 (조건부 행동 제시)

작성일: 2026-01-24
"""

import json
from typing import Dict, Any, Optional
from datetime import datetime

from .briefing_mode import (
    BriefingMode,
    get_mode_constraints,
    get_mode_system_prompt,
)


class PromptBuilder:
    """
    모드별 프롬프트 생성기

    핵심 원칙:
    - 교과서적 정의 삭제 (PMI 50 이상은 확장...)
    - 숫자와 인과관계로만 표현
    - 모호한 표현 금지 (대체로, 약간, 전반적으로)
    """

    # 공통 시스템 프롬프트 (모든 모드에 적용)
    COMMON_SYSTEM_PROMPT = """
## AI 트레이딩 시스템 - 브리핑 생성 규칙

### 너의 역할
너는 트레이딩 리포트를 작성하지 않는다.
너의 출력은 **실행 가능한 트레이딩 프로토콜**이다.

### 절대 금지 (ZERO TOLERANCE)
1. **교과서적 정의**: "PMI 50 이상은 경기 확장을 의미" 같은 설명
2. **모호한 표현**: "전반적으로", "대체로", "약간", "다소"
3. **형용사 남용**: "매우", "상당히", "꽤", "어느 정도"
4. **수동적 표현**: "~될 것으로 보인다", "~할 수 있다"
5. **출처 불명 데이터**: 근거 없는 수치 언급

### 필수 사항
1. **구체적 수치**: $150.25, +2.3%, 4.15% 등 정확한 숫자
2. **인과관계 명시**: "A 때문에 B가 발생" 형식
3. **행동 지침**: "X 조건에서 Y 행동" 형식
4. **시간 명시**: 언제의 데이터인지 명확히

### 경제지표 언급 시 금지 사항
- ❌ "PMI가 50 이상이면 경기 확장, 50 미만이면 경기 수축을 의미합니다"
- ❌ "CPI는 소비자물가지수로 인플레이션을 측정하는 지표입니다"
- ❌ "VIX는 변동성 지수로 공포 지수라고도 불립니다"

**위 같은 교과서적 정의는 읽는 사람이 이미 알고 있다고 가정하라.**
"""

    # 공통 4대 지표 (Closing/Morning 공용)
    CORE_INDICATORS_TEMPLATE = """
### 핵심 4대 지표 (불변 - 항상 포함)
1. **10년물 국채 금리 (US10Y)**: {us10y}
2. **변동성 지수 (VIX)**: {vix}
3. **달러 인덱스 (DXY)**: {dxy}
4. **섹터 로테이션**: {sector_leadership}
"""

    @classmethod
    def build(
        cls,
        mode: BriefingMode,
        data: Dict[str, Any],
        date_str: Optional[str] = None
    ) -> str:
        """
        모드에 맞는 전체 프롬프트 생성

        Args:
            mode: CLOSING | MORNING | INTRADAY | KOREAN
            data: 분석 데이터 (뉴스, 지표, 시그널 등)
            date_str: 날짜 문자열 (YYYY-MM-DD)

        Returns:
            완성된 프롬프트 문자열
        """
        if not date_str:
            date_str = datetime.now().strftime("%Y-%m-%d")

        # 1. 공통 시스템 프롬프트
        prompt = cls.COMMON_SYSTEM_PROMPT

        # 2. 모드별 제약 조건
        prompt += "\n" + get_mode_system_prompt(mode)

        # 3. 모드별 본문 프롬프트
        if mode == BriefingMode.CLOSING:
            prompt += cls._build_closing_body(data, date_str)
        elif mode == BriefingMode.MORNING:
            prompt += cls._build_morning_body(data, date_str)
        elif mode == BriefingMode.INTRADAY:
            prompt += cls._build_intraday_body(data, date_str)
        elif mode == BriefingMode.KOREAN:
            prompt += cls._build_korean_body(data, date_str)

        return prompt

    @classmethod
    def _build_closing_body(cls, data: Dict[str, Any], date_str: str) -> str:
        """Closing 브리핑 본문 (결과 중심)"""
        return f"""
---

## 미국장 마감 브리핑 - {date_str}

**모드**: CLOSING (결과 분석)
**핵심 질문**: "오늘 시장은 왜 이렇게 끝났는가?"

### 데이터

{json.dumps(data, indent=2, ensure_ascii=False)}

---

### 출력 형식 (반드시 준수)

# 🇺🇸 미국장 마감 브리핑 ({date_str})

## 📈 시장 종합 (결과)
- S&P 500: [종가] ([등락률]) - [상승/하락 마감]
- NASDAQ: [종가] ([등락률])
- DOW: [종가] ([등락률])
- **오늘의 스토리**: [한 문장으로 왜 이렇게 끝났는지]

## 📊 경제지표 결과 (CLOSING 전용 - 가정법 금지!)

**발표된 지표만 분석하라. 예정된 지표는 언급하지 마라.**

| 지표 | 예상 | 실제 | 서프라이즈 | 시장 반응 |
|------|------|------|-----------|----------|
| [지표명] | [예상] | [실제] | [차이] | [실제 움직임] |

**결과 해석** (직설법으로만):
- [지표명]: 실제 [X]로 예상 [Y] 대비 [상회/하회].
  발표 직후 [자산]이 [X%] [상승/하락]했다.
  이유: [구체적 인과관계]

## 💰 거시지표 마감

| 지표 | 마감가 | 등락 | 해석 |
|------|--------|------|------|
| 10Y Treasury | [수치] | [+/-bp] | [결과 해석] |
| VIX | [수치] | [등락률] | [결과 해석] |
| DXY | [수치] | [등락률] | [결과 해석] |
| Gold | [수치] | [등락률] | [결과 해석] |

## 🏢 주요 종목 마감

### 상승 마감 Top 5
1. [티커] [종가] ([+X%]) - [상승 이유]

### 하락 마감 Top 5
1. [티커] [종가] ([-X%]) - [하락 이유]

## 📊 매수/매도세 결과
- A/D Line: [결과]
- Put/Call Ratio: [수치] ([해석])
- Dark Pool: [기관 움직임 결과]

## ⚠️ 리스크 분석 결과
- VIX 마감: [수치] → [해석]
- 오늘 발생한 리스크 요인: [구체적 서술]

## 💡 내일을 위한 시사점
- **핵심 포인트**: [오늘 결과가 내일에 미치는 영향]
- **주목 종목**: [내일 모니터링 필요 종목]
- **리스크**: [잔존 리스크]

---

**작성 규칙 재확인**:
1. 가정법(If/시나리오) 절대 금지 - 이미 마감된 시장이다
2. 모든 수치는 "마감" 기준
3. "~할 것이다" 대신 "~했다" 사용
4. 교과서 정의 삭제
"""

    @classmethod
    def _build_morning_body(cls, data: Dict[str, Any], date_str: str) -> str:
        """Morning 브리핑 본문 (시나리오 중심)"""
        return f"""
---

## 프리마켓 브리핑 - {date_str}

**모드**: MORNING (시나리오 분석)
**핵심 질문**: "오늘 장에서 어떻게 대응할 것인가?"

### 데이터

{json.dumps(data, indent=2, ensure_ascii=False)}

---

### 출력 형식 (반드시 준수)

# 🌅 프리마켓 브리핑 ({date_str})

## 📈 시장 상태 신호등

| 신호 | 상태 | 근거 |
|------|------|------|
| 🟢/🟡/🔴 | [Risk-On/Neutral/Risk-Off] | [VIX, 선물, 지정학적 리스크 기반] |

**Top Action (한 줄 결론)**: [오늘 가장 중요한 행동 지침]

## 📅 오늘의 경제지표 시나리오 (MORNING 전용 - IF/THEN 필수!)

**예정된 지표 분석 (가정법으로 작성)**:

### [지표명] - 발표 예정 [시간 KST]
- 예상: [예상치], 이전: [이전치]

| Case | 조건 | 시장 예상 반응 | 대응 전략 |
|------|------|---------------|----------|
| A | 예상 상회 시 (>[X]) | 금리↑, 성장주↓ | QQQ 비중 축소 |
| B | 예상 하회 시 (<[X]) | 금리↓, 성장주↑ | QQQ 비중 확대 |
| C | 예상 부합 시 | 제한적 반응 | 현 포지션 유지 |

## 🎯 Actionable Scenarios (IF-THEN 프로토콜)

### 시나리오 A: [조건]
- **IF**: [구체적 조건 - 예: 10Y > 4.20%]
- **THEN**: [행동 - 예: 기술주 비중 20% 축소]
- **Size**: [비중 - 예: 포트폴리오의 30%]
- **Rationale**: [근거]

### 시나리오 B: [조건]
- **IF**: [구체적 조건]
- **THEN**: [행동]
- **Size**: [비중]
- **Rationale**: [근거]

## 💰 주요 지표 현황 (프리마켓 기준)

| 지표 | 현재 | 전일 대비 | 신호 |
|------|------|----------|------|
| S&P 선물 | [수치] | [등락률] | [해석] |
| 10Y Treasury | [수치] | [+/-bp] | [해석] |
| VIX | [수치] | [등락률] | [해석] |

## 🏢 주목 종목 (오늘 모니터링)

1. **[티커]**: [주목 이유 - 실적 발표, 뉴스 등]
   - 진입 조건: [가격 레벨]
   - 목표가: [가격]
   - 손절가: [가격]

## ⚠️ 리스크 요인
1. [리스크 1] - 영향도: [상/중/하]
2. [리스크 2] - 영향도: [상/중/하]

## 💼 포지션 제안 (Kelly Criterion 기반)

| 항목 | 제안 | 근거 |
|------|------|------|
| 현금 비중 | [X%] | [VIX, 리스크 기반] |
| 주식 비중 | [X%] | [기회 평가 기반] |
| 최대 포지션 | [X%] | [변동성 기반] |

---

**작성 규칙 재확인**:
1. 직설법 금지 - 아직 장이 열리지 않았다
2. 모든 분석은 "예상", "시나리오", "IF/THEN" 형식
3. "마감했다" 대신 "예상된다", "가능성이 있다" 사용
4. 구체적 진입/목표/손절 가격 명시
"""

    @classmethod
    def _build_intraday_body(cls, data: Dict[str, Any], date_str: str) -> str:
        """Intraday 체크포인트 본문 (변동 중심)"""
        return f"""
---

## 장중 체크포인트 - {date_str}

**모드**: INTRADAY (변동 감지)
**핵심 질문**: "유의미한 변동이 있는가?"

### 데이터

{json.dumps(data, indent=2, ensure_ascii=False)}

---

### 출력 형식

**변동폭 임계값**: ±1% 이상 변동 시에만 상세 분석

# ⚡ 장중 체크포인트 ({date_str})

## 변동 감지 결과

| 자산 | 현재 | 시초 대비 | 알림 |
|------|------|----------|------|
| S&P 500 | [수치] | [등락률] | [🔴 급락/🟢 급등/⚪ 정상] |

## 유의미한 변동 (있는 경우만)

### [종목/지수] [+/-X%] 급등/급락
- **발생 시점**: [시간]
- **추정 원인**: [뉴스, 이벤트]
- **대응 제안**: [홀드/익절/손절]

## 모니터링 지속 항목
- [항목 1]
- [항목 2]

---

**변동 없으면 다음 형식으로 출력**:
```json
{{
  "skip": true,
  "reason": "유의미한 변동 없음 (임계값 ±1% 미만)",
  "next_check": "[다음 체크포인트 시간]"
}}
```
"""

    @classmethod
    def _build_korean_body(cls, data: Dict[str, Any], date_str: str) -> str:
        """Korean 브리핑 본문 (연계 분석)"""
        return f"""
---

## 한국장 오픈 브리핑 - {date_str}

**모드**: KOREAN (미국장 연계 분석)
**핵심 질문**: "미국장 결과가 한국장에 어떤 영향을 미치는가?"

### 데이터

{json.dumps(data, indent=2, ensure_ascii=False)}

---

### 출력 형식

# 🇰🇷 한국장 오픈 브리핑 ({date_str})

## 📈 미국장 마감 결과 (연계 분석 기반)

| 지수 | 마감 | 등락 | 한국 영향 |
|------|------|------|----------|
| S&P 500 | [수치] | [등락률] | [코스피 예상 영향] |
| NASDAQ | [수치] | [등락률] | [코스닥 예상 영향] |
| 필라델피아 반도체 | [수치] | [등락률] | [반도체 영향] |

## 🔗 US → KR 섹터 연계

| 미국 섹터 | 미국 결과 | 한국 연관 종목 | 예상 영향 |
|----------|----------|---------------|----------|
| AI/Tech | [등락] | 삼성전자, SK하이닉스 | [예상] |
| 반도체 | [등락] | 삼성전자, SK하이닉스, 한미반도체 | [예상] |
| 에너지 | [등락] | SK이노베이션, S-Oil | [예상] |

## 💱 환율 및 외국인 동향

- USD/KRW: [수치] ([등락])
- 외국인 선물: [순매수/순매도]
- 외국인 예상 동향: [분석]

## 🎯 코스피/코스닥 전망

- **코스피 예상 시초**: [갭업/갭다운/보합]
- **코스닥 예상 시초**: [갭업/갭다운/보합]
- **주목 섹터**: [반도체, 2차전지 등]

## 💼 한국장 전략

1. **매수 관심**: [종목] - [근거]
2. **매도 고려**: [종목] - [근거]
3. **관망 권고**: [상황 설명]
"""


# ============================================================================
# 테스트
# ============================================================================

if __name__ == "__main__":
    # 테스트 데이터
    test_data = {
        "market_summary": {"sp500": 5020.50, "nasdaq": 15850.20},
        "economic_events": [{"name": "PMI", "actual": 50.1, "expected": 49.8}],
    }

    print("=" * 60)
    print("Prompt Builder Test")
    print("=" * 60)

    for mode in BriefingMode:
        print(f"\n{'='*40}")
        print(f"Mode: {mode.value}")
        print("=" * 40)

        prompt = PromptBuilder.build(mode, test_data, "2026-01-24")
        print(prompt[:500] + "...\n")  # 처음 500자만
